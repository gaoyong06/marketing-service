# Marketing Service API æµ‹è¯•é…ç½®
# å‚è€ƒ passport-service çš„æµ‹è¯•é…ç½®æ ¼å¼

# API åŸºç¡€ URL
base_url: http://localhost:8105
# è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
timeout: 30

# è¯·æ±‚é…ç½®
request:
  headers:
    Content-Type: application/json

# è¾“å‡ºç›®å½•
output_dir: ./test-reports
# æ˜¯å¦è¯¦ç»†è¾“å‡º
verbose: true

# æ—¥å¿—é…ç½®
logging:
  verbose: true
  request_response: true
  variable_processing: true

# å…¨å±€å˜é‡å®šä¹‰
variables:
  # æµ‹è¯•æ•°æ®
  test_tenant_id: "tenant1"
  test_product_code: "app1"
  test_user_id: 123
  test_campaign_name: "æµ‹è¯•è¥é”€æ´»åŠ¨"
  test_reward_name: "æµ‹è¯•å¥–åŠ±"
  test_task_name: "æµ‹è¯•ä»»åŠ¡"
  
  # è¾¹ç•Œæµ‹è¯•æ•°æ®
  empty_string: ""
  large_number: "999999999999999"
  
  # ç‰¹æ®Šå­—ç¬¦æµ‹è¯•
  special_chars: "!@#$%^&*()_+-=[]{}|;:',.<>?/~`"
  unicode_chars: "æµ‹è¯•ğŸ‰emojiè¡¨æƒ…ç¬¦å·"

# æµ‹è¯•åœºæ™¯
scenarios:
  # ==================== åŸºç¡€åŠŸèƒ½æµ‹è¯• ====================
  
  # 1. å¥åº·æ£€æŸ¥
  - name: 01-å¥åº·æ£€æŸ¥
    description: æµ‹è¯•æœåŠ¡å¥åº·çŠ¶æ€
    steps:
      - name: æ£€æŸ¥æœåŠ¡å¥åº·
        endpoint: /health
        method: GET
        assert:
          status: 200
          body:
            $.status: UP
            $.service: marketing-service

  # 2. Prometheus Metrics ç«¯ç‚¹
  - name: 02-PrometheusæŒ‡æ ‡ç«¯ç‚¹
    description: æµ‹è¯• Prometheus metrics ç«¯ç‚¹
    steps:
      - name: è·å–æŒ‡æ ‡
        endpoint: /metrics
        method: GET
        assert:
          status: 200

  # ==================== Campaign åŠŸèƒ½æµ‹è¯• ====================
  
  # 3. Campaign åˆ›å»ºæ­£å¸¸æµç¨‹
  - name: 03-Campaignåˆ›å»ºæ­£å¸¸æµç¨‹
    description: æµ‹è¯• Campaign åˆ›å»ºçš„æ­£å¸¸æµç¨‹
    steps:
      - name: åˆ›å»ºCampaign
        endpoint: /v1/campaigns
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_name: "{{.test_campaign_name}}"
          campaign_type: "PROMOTION"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.campaign.campaign_id: "!null"
            $.campaign.campaign_name: "{{.test_campaign_name}}"
        extract:
          campaignId: $.campaign.campaign_id

  # 4. Campaign æŸ¥è¯¢æ­£å¸¸æµç¨‹
  - name: 04-CampaignæŸ¥è¯¢æ­£å¸¸æµç¨‹
    description: æµ‹è¯• Campaign æŸ¥è¯¢çš„æ­£å¸¸æµç¨‹
    steps:
      - name: è·å–Campaign
        endpoint: /v1/campaigns/{{.campaignId}}
        method: GET
        dependencies: [åˆ›å»ºCampaign]
        assert:
          status: 200
          body:
            $.campaign.campaign_id: "{{.campaignId}}"

  # 5. Campaign åˆ—è¡¨æŸ¥è¯¢
  - name: 05-Campaignåˆ—è¡¨æŸ¥è¯¢
    description: æµ‹è¯• Campaign åˆ—è¡¨æŸ¥è¯¢
    steps:
      - name: åˆ—å‡ºCampaigns
        endpoint: /v1/campaigns
        method: GET
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.campaigns: "!null"

  # ==================== Reward åŠŸèƒ½æµ‹è¯• ====================
  
  # 6. Reward åˆ›å»ºæ­£å¸¸æµç¨‹
  - name: 06-Rewardåˆ›å»ºæ­£å¸¸æµç¨‹
    description: æµ‹è¯• Reward åˆ›å»ºçš„æ­£å¸¸æµç¨‹
    steps:
      - name: åˆ›å»ºReward
        endpoint: /v1/rewards
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          reward_type: "COUPON"
          name: "{{.test_reward_name}}"
          content_config: '{"discount_type":"AMOUNT","discount_value":10}'
          valid_days: 30
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.reward.reward_id: "!null"
            $.reward.name: "{{.test_reward_name}}"
        extract:
          rewardId: $.reward.reward_id

  # 7. Reward æŸ¥è¯¢æ­£å¸¸æµç¨‹
  - name: 07-RewardæŸ¥è¯¢æ­£å¸¸æµç¨‹
    description: æµ‹è¯• Reward æŸ¥è¯¢çš„æ­£å¸¸æµç¨‹
    steps:
      - name: è·å–Reward
        endpoint: /v1/rewards/{{.rewardId}}
        method: GET
        dependencies: [åˆ›å»ºReward]
        assert:
          status: 200
          body:
            $.reward.reward_id: "{{.rewardId}}"

  # ==================== Task åŠŸèƒ½æµ‹è¯• ====================
  
  # 8. Task åˆ›å»ºæ­£å¸¸æµç¨‹
  - name: 08-Taskåˆ›å»ºæ­£å¸¸æµç¨‹
    description: æµ‹è¯• Task åˆ›å»ºçš„æ­£å¸¸æµç¨‹
    steps:
      - name: åˆ›å»ºTask
        endpoint: /v1/tasks
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          name: "{{.test_task_name}}"
          task_type: "SIGN_IN"
          trigger_config: '{"event":"USER_REGISTER"}'
          condition_config: '{"type":"count","operator":">=","value":1}'
          reward_id: "{{.rewardId}}"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          max_count: 1
          created_by: "test_user"
        dependencies: [åˆ›å»ºReward]
        assert:
          status: 200
          body:
            $.task.task_id: "!null"
            $.task.name: "{{.test_task_name}}"
        extract:
          taskId: $.task.task_id

  # 9. Task è§¦å‘äº‹ä»¶
  - name: 09-Taskè§¦å‘äº‹ä»¶
    description: æµ‹è¯• Task äº‹ä»¶è§¦å‘
    steps:
      - name: è§¦å‘ä»»åŠ¡äº‹ä»¶
        endpoint: /v1/tasks/trigger
        method: POST
        dependencies: [åˆ›å»ºTask, åˆ›å»ºCampaign]
        request_body:
          event_type: "USER_REGISTER"
          user_id: {{.test_user_id}}
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_id: "{{.campaignId}}"
          campaign_name: "{{.test_campaign_name}}"
          event_data:
            count: 1
        assert:
          status: 200
          body:
            $.success: true

  # ==================== å…‘æ¢ç åŠŸèƒ½æµ‹è¯• ====================
  
  # 10. ç”Ÿæˆå…‘æ¢ç 
  - name: 10-ç”Ÿæˆå…‘æ¢ç 
    description: æµ‹è¯•å…‘æ¢ç ç”Ÿæˆ
    steps:
      - name: ç”Ÿæˆå…‘æ¢ç 
        endpoint: /v1/campaigns/{{.campaignId}}/redeem-codes
        method: POST
        dependencies: [åˆ›å»ºCampaign, åˆ›å»ºReward]
        request_body:
          reward_id: "{{.rewardId}}"
          count: 10
          expire_time: "2024-12-31T23:59:59Z"
        assert:
          status: 200
          body:
            $.batch_id: "!null"
            $.total: 10
        extract:
          batchId: $.batch_id
          sampleCode: $.sample_codes[0]

  # 11. å…‘æ¢ç æ ¸é”€
  - name: 11-å…‘æ¢ç æ ¸é”€
    description: æµ‹è¯•å…‘æ¢ç æ ¸é”€
    steps:
      - name: æ ¸é”€å…‘æ¢ç 
        endpoint: /v1/redeem
        method: POST
        dependencies: [ç”Ÿæˆå…‘æ¢ç ]
        request_body:
          code: "{{.sampleCode}}"
          product_code: "{{.test_product_code}}"
          user_id: {{.test_user_id}}
        assert:
          status: 200
          body:
            $.success: true

  # ==================== å¼‚å¸¸åœºæ™¯æµ‹è¯• ====================
  
  # 12. Campaign åˆ›å»ºå¼‚å¸¸åœºæ™¯
  - name: 12-Campaignåˆ›å»ºå¼‚å¸¸åœºæ™¯
    description: æµ‹è¯• Campaign åˆ›å»ºçš„å„ç§å¼‚å¸¸æƒ…å†µ
    steps:
      - name: åˆ›å»ºCampaign-ç©ºåç§°
        endpoint: /v1/campaigns
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_name: ""
          campaign_type: "PROMOTION"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
        assert:
          status: [400, 500]

      - name: åˆ›å»ºCampaign-æ— æ•ˆæ—¶é—´
        endpoint: /v1/campaigns
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_name: "æµ‹è¯•æ´»åŠ¨"
          campaign_type: "PROMOTION"
          start_time: "invalid-time"
          end_time: "2024-12-31T23:59:59Z"
        assert:
          status: [400, 500]

  # 13. Reward æŸ¥è¯¢å¼‚å¸¸åœºæ™¯
  - name: 13-RewardæŸ¥è¯¢å¼‚å¸¸åœºæ™¯
    description: æµ‹è¯• Reward æŸ¥è¯¢çš„å¼‚å¸¸æƒ…å†µ
    steps:
      - name: è·å–ä¸å­˜åœ¨çš„Reward
        endpoint: /v1/rewards/non-existent-id
        method: GET
        assert:
          status: [200, 404, 500]

  # ==================== åº“å­˜ç®¡ç†æµ‹è¯• ====================
  
  # 14. åº“å­˜é¢„å 
  - name: 14-åº“å­˜é¢„å 
    description: æµ‹è¯•åº“å­˜é¢„å åŠŸèƒ½
    steps:
      - name: é¢„å åº“å­˜
        endpoint: /v1/inventory/reserve
        method: POST
        dependencies: [åˆ›å»ºReward]
        request_body:
          resource_id: "{{.rewardId}}"
          campaign_id: "{{.campaignId}}"
          user_id: {{.test_user_id}}
          quantity: 1
          expire_minutes: 30
        assert:
          status: 200
          body:
            $.reservation.reservation_id: "!null"
        extract:
          reservationId: $.reservation.reservation_id

  # 15. åº“å­˜ç¡®è®¤
  - name: 15-åº“å­˜ç¡®è®¤
    description: æµ‹è¯•åº“å­˜ç¡®è®¤åŠŸèƒ½
    steps:
      - name: ç¡®è®¤åº“å­˜
        endpoint: /v1/inventory/{{.reservationId}}/confirm
        method: POST
        dependencies: [åº“å­˜é¢„å ]
        assert:
          status: 200
          body:
            $.success: true

  # ==================== ä»»åŠ¡å®Œæˆæ—¥å¿—æŸ¥è¯¢æµ‹è¯• ====================
  
  # 16. ä»»åŠ¡å®Œæˆæ—¥å¿—æŸ¥è¯¢
  - name: 16-ä»»åŠ¡å®Œæˆæ—¥å¿—æŸ¥è¯¢
    description: æµ‹è¯•ä»»åŠ¡å®Œæˆæ—¥å¿—æŸ¥è¯¢
    steps:
      - name: åˆ—å‡ºä»»åŠ¡å®Œæˆæ—¥å¿—
        endpoint: /v1/task-completion-logs
        method: GET
        dependencies: [è§¦å‘ä»»åŠ¡äº‹ä»¶]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          task_id: "{{.taskId}}"
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.logs: "!null"

  # 17. ä»»åŠ¡å®Œæˆç»Ÿè®¡
  - name: 17-ä»»åŠ¡å®Œæˆç»Ÿè®¡
    description: æµ‹è¯•ä»»åŠ¡å®Œæˆç»Ÿè®¡
    steps:
      - name: è·å–ä»»åŠ¡å®Œæˆç»Ÿè®¡
        endpoint: /v1/tasks/{{.taskId}}/completion-stats
        method: GET
        dependencies: [è§¦å‘ä»»åŠ¡äº‹ä»¶]
        assert:
          status: 200
          body:
            $.task_id: "{{.taskId}}"
            $.total_completions: ">=0"
            $.unique_users: ">=0"

  # ==================== å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯• ====================
  # è¿™äº›æµ‹è¯•åœºæ™¯æ¥è‡ª internal/integration/task_trigger_test.go
  
  # 18. å®Œæ•´ä»»åŠ¡è§¦å‘æµç¨‹ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰
  - name: 18-å®Œæ•´ä»»åŠ¡è§¦å‘æµç¨‹
    description: æµ‹è¯•å®Œæ•´çš„ä»»åŠ¡è§¦å‘å’Œå¥–åŠ±å‘æ”¾æµç¨‹ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰
    steps:
      # æ­¥éª¤1: åˆ›å»ºæ´»åŠ¨
      - name: åˆ›å»ºæ´»åŠ¨-ä»»åŠ¡è§¦å‘æµç¨‹
        endpoint: /v1/campaigns
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_name: "æµ‹è¯•æ´»åŠ¨-ä»»åŠ¡è§¦å‘"
          campaign_type: "PROMOTION"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.campaign.campaign_id: "!null"
        extract:
          taskTriggerCampaignId: $.campaign.campaign_id

      # æ­¥éª¤2: åˆ›å»ºå¥–åŠ±
      - name: åˆ›å»ºå¥–åŠ±-ä»»åŠ¡è§¦å‘æµç¨‹
        endpoint: /v1/rewards
        method: POST
        dependencies: [åˆ›å»ºæ´»åŠ¨-ä»»åŠ¡è§¦å‘æµç¨‹]
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          reward_type: "COUPON"
          name: "æµ‹è¯•ä¼˜æƒ åˆ¸-ä»»åŠ¡è§¦å‘"
          content_config: '{"discount_type":"AMOUNT","discount_value":10}'
          valid_days: 30
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.reward.reward_id: "!null"
        extract:
          taskTriggerRewardId: $.reward.reward_id

      # æ­¥éª¤3: åˆ›å»ºä»»åŠ¡
      - name: åˆ›å»ºä»»åŠ¡-ä»»åŠ¡è§¦å‘æµç¨‹
        endpoint: /v1/tasks
        method: POST
        dependencies: [åˆ›å»ºå¥–åŠ±-ä»»åŠ¡è§¦å‘æµç¨‹]
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          name: "æ–°ç”¨æˆ·æ³¨å†Œä»»åŠ¡"
          task_type: "SIGN_IN"
          trigger_config: '{"event":"USER_REGISTER"}'
          condition_config: '{"type":"count","operator":">=","value":1}'
          reward_id: "{{.taskTriggerRewardId}}"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          max_count: 1
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.task.task_id: "!null"
        extract:
          taskTriggerTaskId: $.task.task_id

      # æ­¥éª¤4: è§¦å‘ä»»åŠ¡äº‹ä»¶
      - name: è§¦å‘ä»»åŠ¡äº‹ä»¶-å®Œæ•´æµç¨‹
        endpoint: /v1/tasks/trigger
        method: POST
        dependencies: [åˆ›å»ºä»»åŠ¡-ä»»åŠ¡è§¦å‘æµç¨‹, åˆ›å»ºæ´»åŠ¨-ä»»åŠ¡è§¦å‘æµç¨‹]
        request_body:
          event_type: "USER_REGISTER"
          user_id: {{.test_user_id}}
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_id: "{{.taskTriggerCampaignId}}"
          campaign_name: "æµ‹è¯•æ´»åŠ¨-ä»»åŠ¡è§¦å‘"
          event_data:
            count: 1
        assert:
          status: 200
          body:
            $.success: true

      # æ­¥éª¤5: éªŒè¯å¥–åŠ±å‘æ”¾è®°å½•
      - name: éªŒè¯å¥–åŠ±å‘æ”¾è®°å½•
        endpoint: /v1/reward-grants
        method: GET
        dependencies: [è§¦å‘ä»»åŠ¡äº‹ä»¶-å®Œæ•´æµç¨‹]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          user_id: {{.test_user_id}}
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.grants: "!null"
            $.grants[0].reward_id: "{{.taskTriggerRewardId}}"
            $.grants[0].user_id: {{.test_user_id}}
            $.grants[0].status: "DISTRIBUTED"
            $.grants[0].content_snapshot: "!null"
        extract:
          grantId: $.grants[0].grant_id

      # æ­¥éª¤6: éªŒè¯ä»»åŠ¡å®Œæˆæ—¥å¿—
      - name: éªŒè¯ä»»åŠ¡å®Œæˆæ—¥å¿—
        endpoint: /v1/task-completion-logs
        method: GET
        dependencies: [è§¦å‘ä»»åŠ¡äº‹ä»¶-å®Œæ•´æµç¨‹]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          task_id: "{{.taskTriggerTaskId}}"
          user_id: {{.test_user_id}}
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.logs: "!null"
            $.logs[0].task_id: "{{.taskTriggerTaskId}}"
            $.logs[0].user_id: {{.test_user_id}}
            $.logs[0].grant_id: "!null"

  # 19. å¥–åŠ±ç”Ÿæˆæµç¨‹æµ‹è¯•
  - name: 19-å¥–åŠ±ç”Ÿæˆæµç¨‹
    description: æµ‹è¯•å¥–åŠ±ç”Ÿæˆæµç¨‹ï¼ˆåˆ›å»ºå¥–åŠ±æ¨¡æ¿ï¼ŒéªŒè¯ç”Ÿæˆå™¨ï¼‰
    steps:
      # æ­¥éª¤1: åˆ›å»ºå…‘æ¢ç ç±»å‹å¥–åŠ±
      - name: åˆ›å»ºå…‘æ¢ç å¥–åŠ±
        endpoint: /v1/rewards
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          reward_type: "REDEEM_CODE"
          name: "å…‘æ¢ç å¥–åŠ±"
          content_config: '{"code_type":"COUPON","value":50}'
          generator_config: '{"type":"CODE"}'
          valid_days: 30
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.reward.reward_id: "!null"
            $.reward.reward_type: "REDEEM_CODE"
        extract:
          redeemCodeRewardId: $.reward.reward_id

      # æ­¥éª¤2: é€šè¿‡è§¦å‘ä»»åŠ¡äº‹ä»¶æ¥æµ‹è¯•å¥–åŠ±ç”Ÿæˆï¼ˆé—´æ¥æµ‹è¯•ç”Ÿæˆå™¨ï¼‰
      - name: åˆ›å»ºä»»åŠ¡å…³è”å…‘æ¢ç å¥–åŠ±
        endpoint: /v1/tasks
        method: POST
        dependencies: [åˆ›å»ºå…‘æ¢ç å¥–åŠ±]
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          name: "å…‘æ¢ç ä»»åŠ¡"
          task_type: "SIGN_IN"
          trigger_config: '{"event":"USER_SIGN_IN"}'
          condition_config: '{"type":"count","operator":">=","value":1}'
          reward_id: "{{.redeemCodeRewardId}}"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          max_count: 1
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.task.task_id: "!null"
        extract:
          redeemCodeTaskId: $.task.task_id

      # æ­¥éª¤3: è§¦å‘ä»»åŠ¡äº‹ä»¶ï¼ŒéªŒè¯å¥–åŠ±ç”Ÿæˆ
      - name: è§¦å‘ä»»åŠ¡äº‹ä»¶-å¥–åŠ±ç”Ÿæˆ
        endpoint: /v1/tasks/trigger
        method: POST
        dependencies: [åˆ›å»ºä»»åŠ¡å…³è”å…‘æ¢ç å¥–åŠ±]
        request_body:
          event_type: "USER_SIGN_IN"
          user_id: 456
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          event_data:
            count: 1
        assert:
          status: 200
          body:
            $.success: true

      # æ­¥éª¤4: éªŒè¯ç”Ÿæˆçš„å¥–åŠ±å†…å®¹ï¼ˆé€šè¿‡å¥–åŠ±å‘æ”¾è®°å½•ï¼‰
      - name: éªŒè¯ç”Ÿæˆçš„å¥–åŠ±å†…å®¹
        endpoint: /v1/reward-grants
        method: GET
        dependencies: [è§¦å‘ä»»åŠ¡äº‹ä»¶-å¥–åŠ±ç”Ÿæˆ]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          user_id: 456
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.grants: "!null"
            $.grants[0].reward_id: "{{.redeemCodeRewardId}}"
            $.grants[0].content_snapshot: "!null"
            # éªŒè¯ç”Ÿæˆçš„å†…å®¹æ˜¯æœ‰æ•ˆçš„ JSONï¼ˆåŒ…å« code å­—æ®µï¼‰
            $.grants[0].content_snapshot: "contains:code"

  # ==================== ä»»åŠ¡è§¦å‘æœåŠ¡å•å…ƒæµ‹è¯•åœºæ™¯ ====================
  # è¿™äº›æµ‹è¯•åœºæ™¯æ¥è‡ª internal/biz/task_trigger_test.go
  
  # 20. ä»»åŠ¡è§¦å‘æœåŠ¡-é‚€è¯·ä»»åŠ¡æµ‹è¯•
  - name: 20-ä»»åŠ¡è§¦å‘æœåŠ¡-é‚€è¯·ä»»åŠ¡
    description: æµ‹è¯•ä»»åŠ¡è§¦å‘æœåŠ¡çš„é‚€è¯·ä»»åŠ¡åœºæ™¯ï¼ˆæ¥è‡ª task_trigger_test.goï¼‰
    steps:
      # æ­¥éª¤1: åˆ›å»ºæ´»åŠ¨
      - name: åˆ›å»ºæ´»åŠ¨-é‚€è¯·ä»»åŠ¡
        endpoint: /v1/campaigns
        method: POST
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          campaign_name: "é‚€è¯·ä»»åŠ¡æ´»åŠ¨"
          campaign_type: "PROMOTION"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.campaign.campaign_id: "!null"
        extract:
          inviteTaskCampaignId: $.campaign.campaign_id

      # æ­¥éª¤2: åˆ›å»ºå¥–åŠ±
      - name: åˆ›å»ºå¥–åŠ±-é‚€è¯·ä»»åŠ¡
        endpoint: /v1/rewards
        method: POST
        dependencies: [åˆ›å»ºæ´»åŠ¨-é‚€è¯·ä»»åŠ¡]
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          reward_type: "COUPON"
          name: "é‚€è¯·ä»»åŠ¡å¥–åŠ±"
          content_config: "{}"
          valid_days: 7
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.reward.reward_id: "!null"
        extract:
          inviteTaskRewardId: $.reward.reward_id

      # æ­¥éª¤3: åˆ›å»ºé‚€è¯·ä»»åŠ¡
      - name: åˆ›å»ºé‚€è¯·ä»»åŠ¡
        endpoint: /v1/tasks
        method: POST
        dependencies: [åˆ›å»ºå¥–åŠ±-é‚€è¯·ä»»åŠ¡]
        request_body:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          name: "é‚€è¯·æ–°ç”¨æˆ·"
          task_type: "INVITE"
          trigger_config: '{"event":"USER_REGISTER"}'
          condition_config: '{"type":"invite_count","operator":">=","value":1}'
          reward_id: "{{.inviteTaskRewardId}}"
          start_time: "2024-01-01T00:00:00Z"
          end_time: "2024-12-31T23:59:59Z"
          max_count: 0
          created_by: "test_user"
        assert:
          status: 200
          body:
            $.task.task_id: "!null"
        extract:
          inviteTaskId: $.task.task_id

      # æ­¥éª¤4: è§¦å‘é‚€è¯·ä»»åŠ¡äº‹ä»¶
      - name: è§¦å‘é‚€è¯·ä»»åŠ¡äº‹ä»¶
        endpoint: /v1/tasks/trigger
        method: POST
        dependencies: [åˆ›å»ºé‚€è¯·ä»»åŠ¡]
        request_body:
          event_type: "USER_REGISTER"
          user_id: 123
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          event_data:
            invite_count: 1
        assert:
          status: 200
          body:
            $.success: true

      # æ­¥éª¤5: éªŒè¯ä»»åŠ¡å®Œæˆæ—¥å¿—
      - name: éªŒè¯é‚€è¯·ä»»åŠ¡å®Œæˆæ—¥å¿—
        endpoint: /v1/task-completion-logs
        method: GET
        dependencies: [è§¦å‘é‚€è¯·ä»»åŠ¡äº‹ä»¶]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          task_id: "{{.inviteTaskId}}"
          user_id: 123
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.logs: "!null"
            $.logs[0].task_id: "{{.inviteTaskId}}"
            $.logs[0].user_id: 123

      # æ­¥éª¤6: éªŒè¯å¥–åŠ±å‘æ”¾è®°å½•
      - name: éªŒè¯é‚€è¯·ä»»åŠ¡å¥–åŠ±å‘æ”¾
        endpoint: /v1/reward-grants
        method: GET
        dependencies: [è§¦å‘é‚€è¯·ä»»åŠ¡äº‹ä»¶]
        query_params:
          tenant_id: "{{.test_tenant_id}}"
          product_code: "{{.test_product_code}}"
          user_id: 123
          page_size: 10
          page_num: 1
        assert:
          status: 200
          body:
            $.grants: "!null"
            $.grants[0].reward_id: "{{.inviteTaskRewardId}}"
            $.grants[0].status: "DISTRIBUTED"

