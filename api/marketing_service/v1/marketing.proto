syntax = "proto3";

package platform.marketing_service.v1;

import "google/api/annotations.proto";
import "validate/validate.proto";
import "google/protobuf/empty.proto";

option go_package = "marketing-service/api/marketing_service/v1;v1";

// MarketingService 营销服务API（极简重构版：仅保留优惠券功能）
service Marketing {
  // ========== Coupon Management API (供开发者控制台使用) ==========
  // CreateCoupon 创建优惠券
  rpc CreateCoupon(CreateCouponRequest) returns (CreateCouponReply) {
    option (google.api.http) = {
      post: "/v1/coupons"
      body: "*"
    };
  }

  // GetCoupon 获取优惠券
  rpc GetCoupon(GetCouponRequest) returns (GetCouponReply) {
    option (google.api.http) = {
      get: "/v1/coupons/{couponCode}"
    };
  }

  // ListCoupons 列出优惠券
  rpc ListCoupons(ListCouponsRequest) returns (ListCouponsReply) {
    option (google.api.http) = {
      get: "/v1/coupons"
    };
  }

  // UpdateCoupon 更新优惠券
  rpc UpdateCoupon(UpdateCouponRequest) returns (UpdateCouponReply) {
    option (google.api.http) = {
      put: "/v1/coupons/{couponCode}"
      body: "*"
    };
  }

  // DeleteCoupon 删除优惠券
  rpc DeleteCoupon(DeleteCouponRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/v1/coupons/{couponCode}"
    };
  }

  // ValidateCoupon 验证优惠券 (供 Payment Service 调用)
  rpc ValidateCoupon(ValidateCouponRequest) returns (ValidateCouponReply) {
    option (google.api.http) = {
      post: "/v1/coupons/validate"
      body: "*"
    };
  }

  // UseCoupon 使用优惠券 (供 Payment Service 调用)
  rpc UseCoupon(UseCouponRequest) returns (UseCouponReply) {
    option (google.api.http) = {
      post: "/v1/coupons/use"
      body: "*"
    };
  }

  // GetCouponStats 获取优惠券统计
  rpc GetCouponStats(GetCouponStatsRequest) returns (GetCouponStatsReply) {
    option (google.api.http) = {
      get: "/v1/coupons/{couponCode}/stats"
    };
  }

  // ListCouponUsages 列出优惠券使用记录
  rpc ListCouponUsages(ListCouponUsagesRequest) returns (ListCouponUsagesReply) {
    option (google.api.http) = {
      get: "/v1/coupons/{couponCode}/usages"
    };
  }

  // GetCouponsSummaryStats 获取所有优惠券汇总统计（供营销效果仪表板使用）
  rpc GetCouponsSummaryStats(GetCouponsSummaryStatsRequest) returns (GetCouponsSummaryStatsReply) {
    option (google.api.http) = {
      get: "/v1/coupons/summary-stats"
    };
  }
}

// ========== Coupon Messages ==========

// Coupon 优惠券
message Coupon {
  string couponCode = 1;             // 优惠码
  string appId = 2;                  // 应用ID
  string discountType = 3;           // 折扣类型: percent/fixed
  int64 discountValue = 4;           // 折扣值(百分比或分)
  string currency = 13;               // 货币单位: CNY/USD/EUR 等，仅固定金额类型需要，默认 CNY
  int64 validFrom = 5;               // 生效时间(timestamp)
  int64 validUntil = 6;              // 过期时间(timestamp)
  int32 maxUses = 7;                 // 最大使用次数
  int32 usedCount = 8;               // 已使用次数
  int64 minAmount = 9;               // 最低消费金额(分)
  string status = 10;                 // 状态: active/inactive/expired
  int64 createdAt = 11;              // 创建时间(timestamp)
  int64 updatedAt = 12;              // 更新时间(timestamp)
}

// CreateCouponRequest 创建优惠券请求
message CreateCouponRequest {
  string couponCode = 1 [(validate.rules).string = {min_len: 1, max_len: 50}];
  string discountType = 2 [(validate.rules).string = {in: ["percent", "fixed"]}];
  int64 discountValue = 3 [(validate.rules).int64.gt = 0];
  string currency = 4;                 // 货币单位: CNY/USD/EUR 等，仅固定金额类型需要，默认 CNY
  int64 validFrom = 5;
  int64 validUntil = 6;
  int32 maxUses = 7 [(validate.rules).int32.gt = 0];
  int64 minAmount = 8;
}

// CreateCouponReply 创建优惠券响应
message CreateCouponReply {
  Coupon coupon = 1;
}

// GetCouponRequest 获取优惠券请求
message GetCouponRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
}

// GetCouponReply 获取优惠券响应
message GetCouponReply {
  Coupon coupon = 1;
}

// ListCouponsRequest 列出优惠券请求
message ListCouponsRequest {
  string appId = 1;  // 应用ID（查询参数，必填）
  string status = 2;
  int32 page = 3;
  int32 pageSize = 4;
}

// ListCouponsReply 列出优惠券响应
message ListCouponsReply {
  repeated Coupon coupons = 1;
  int32 total = 2;
  int32 page = 3;
  int32 pageSize = 4;
}

// UpdateCouponRequest 更新优惠券请求
message UpdateCouponRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
  string discountType = 2;
  int64 discountValue = 3;
  string currency = 10;                 // 货币单位: CNY/USD/EUR 等，仅固定金额类型需要
  int64 validFrom = 4;
  int64 validUntil = 5;
  int32 maxUses = 6;
  int64 minAmount = 7;
  string status = 8;
}

// UpdateCouponReply 更新优惠券响应
message UpdateCouponReply {
  Coupon coupon = 1;
}

// DeleteCouponRequest 删除优惠券请求
message DeleteCouponRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
}

// ValidateCouponRequest 验证优惠券请求 (供 Payment Service 调用)
message ValidateCouponRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
  int64 amount = 2 [(validate.rules).int64.gt = 0];  // 订单金额(分)
}

// ValidateCouponReply 验证优惠券响应
message ValidateCouponReply {
  bool valid = 1;
  string message = 2;
  int64 discountAmount = 3;          // 折扣金额(分)
  int64 finalAmount = 4;             // 最终金额(分)
  Coupon coupon = 5;
}

// UseCouponRequest 使用优惠券请求 (供 Payment Service 调用)
message UseCouponRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
  string appId = 2 [(validate.rules).string.min_len = 1];     // 应用ID
  uint64 userId = 3 [(validate.rules).uint64.gt = 0];
  string paymentOrderId = 4 [(validate.rules).string.min_len = 1]; // 支付订单ID（payment-service的业务订单号orderId）
  string paymentId = 5 [(validate.rules).string.min_len = 1];
  int64 originalAmount = 6 [(validate.rules).int64.gt = 0];
  int64 discountAmount = 7 [(validate.rules).int64.gte = 0];
  int64 finalAmount = 8 [(validate.rules).int64.gt = 0];
}

// UseCouponReply 使用优惠券响应
message UseCouponReply {
  bool success = 1;
  string message = 2;
}

// GetCouponStatsRequest 获取优惠券统计请求
message GetCouponStatsRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
}

// GetCouponStatsReply 获取优惠券统计响应
message GetCouponStatsReply {
  string couponCode = 1;
  int32 totalUses = 2;               // 使用次数
  int32 totalOrders = 3;             // 订单数
  int64 totalRevenue = 4;            // 产生收入(分)
  int64 totalDiscount = 5;           // 折扣金额(分)
  float conversionRate = 6;          // 转化率
}

// CouponUsage 优惠券使用记录
message CouponUsage {
  string couponUsageId = 1;
  string couponCode = 2;
  string appId = 3;                  // 应用ID
  uint64 userId = 4;
  string paymentOrderId = 5; // 支付订单ID（payment-service的业务订单号orderId）
  string paymentId = 6;
  int64 originalAmount = 7;          // 原价(分)
  int64 discountAmount = 8;          // 折扣金额(分)
  int64 finalAmount = 9;             // 实付金额(分)
  int64 usedAt = 10;                  // 使用时间(timestamp)
}

// ListCouponUsagesRequest 列出优惠券使用记录请求
message ListCouponUsagesRequest {
  string couponCode = 1 [(validate.rules).string.min_len = 1];
  int32 page = 2;
  int32 pageSize = 3;
}

// ListCouponUsagesReply 列出优惠券使用记录响应
message ListCouponUsagesReply {
  repeated CouponUsage usages = 1;
  int32 total = 2;
  int32 page = 3;
  int32 pageSize = 4;
}

// GetCouponsSummaryStatsRequest 获取所有优惠券汇总统计请求
message GetCouponsSummaryStatsRequest {
  string appId = 1;  // 应用ID（查询参数，必填）
}

// GetCouponsSummaryStatsReply 获取所有优惠券汇总统计响应
message GetCouponsSummaryStatsReply {
  int32 totalCoupons = 1;          // 优惠券总数
  int32 activeCoupons = 2;         // 激活的优惠券数
  int32 totalUses = 3;             // 总使用次数
  int32 totalOrders = 4;           // 总订单数
  int64 totalRevenue = 5;          // 总收入(分)
  int64 totalDiscount = 6;          // 总折扣金额(分)
  float averageConversionRate = 7; // 平均转化率
  repeated CouponStats topCoupons = 8; // 前N个优惠券的详细统计（按使用次数排序）
}

// CouponStats 优惠券统计（用于汇总统计响应）
message CouponStats {
  string couponCode = 1;
  int32 totalUses = 2;
  int32 totalOrders = 3;
  int64 totalRevenue = 4;
  int64 totalDiscount = 5;
  float conversionRate = 6;
}

