syntax = "proto3";

package platform.marketing_service.v1;

import "google/api/annotations.proto";
import "validate/validate.proto";
import "google/protobuf/timestamp.proto";

option go_package = "marketing-service/api/marketing_service/v1;v1";

// MarketingService 营销服务API
service Marketing {
  // CreateCampaign 创建营销活动
  rpc CreateCampaign(CreateCampaignRequest) returns (CreateCampaignReply) {
    option (google.api.http) = {
      post: "/v1/campaigns"
      body: "*"
    };
  }

  // GetCampaign 获取营销活动
  rpc GetCampaign(GetCampaignRequest) returns (GetCampaignReply) {
    option (google.api.http) = {
      get: "/v1/campaigns/{campaign_id}"
    };
  }

  // ListCampaigns 列出营销活动
  rpc ListCampaigns(ListCampaignsRequest) returns (ListCampaignsReply) {
    option (google.api.http) = {
      get: "/v1/campaigns"
    };
  }

  // UpdateCampaign 更新营销活动
  rpc UpdateCampaign(UpdateCampaignRequest) returns (UpdateCampaignReply) {
    option (google.api.http) = {
      put: "/v1/campaigns/{campaign_id}"
      body: "*"
    };
  }

  // DeleteCampaign 删除营销活动
  rpc DeleteCampaign(DeleteCampaignRequest) returns (DeleteCampaignReply) {
    option (google.api.http) = {
      delete: "/v1/campaigns/{campaign_id}"
    };
  }

  // GenerateRedeemCodes 生成兑换码
  rpc GenerateRedeemCodes(GenerateRedeemCodesRequest) returns (GenerateRedeemCodesReply) {
    option (google.api.http) = {
      post: "/v1/campaigns/{campaign_id}/redeem-codes"
      body: "*"
    };
  }

  // RedeemCode 兑换码核销
  rpc RedeemCode(RedeemCodeRequest) returns (RedeemCodeReply) {
    option (google.api.http) = {
      post: "/v1/redeem"
      body: "*"
    };
  }

  // AssignRedeemCode 分配兑换码
  rpc AssignRedeemCode(AssignRedeemCodeRequest) returns (AssignRedeemCodeReply) {
    option (google.api.http) = {
      post: "/v1/redeem-codes/{code}/assign"
      body: "*"
    };
  }

  // ListRedeemCodes 列出兑换码
  rpc ListRedeemCodes(ListRedeemCodesRequest) returns (ListRedeemCodesReply) {
    option (google.api.http) = {
      get: "/v1/redeem-codes"
    };
  }

  // GetRedeemCode 获取兑换码
  rpc GetRedeemCode(GetRedeemCodeRequest) returns (GetRedeemCodeReply) {
    option (google.api.http) = {
      get: "/v1/redeem-codes/{code}"
    };
  }

  // ========== Reward API ==========
  // CreateReward 创建奖励
  rpc CreateReward(CreateRewardRequest) returns (CreateRewardReply) {
    option (google.api.http) = {
      post: "/v1/rewards"
      body: "*"
    };
  }

  // GetReward 获取奖励
  rpc GetReward(GetRewardRequest) returns (GetRewardReply) {
    option (google.api.http) = {
      get: "/v1/rewards/{reward_id}"
    };
  }

  // ListRewards 列出奖励
  rpc ListRewards(ListRewardsRequest) returns (ListRewardsReply) {
    option (google.api.http) = {
      get: "/v1/rewards"
    };
  }

  // UpdateReward 更新奖励
  rpc UpdateReward(UpdateRewardRequest) returns (UpdateRewardReply) {
    option (google.api.http) = {
      put: "/v1/rewards/{reward_id}"
      body: "*"
    };
  }

  // DeleteReward 删除奖励
  rpc DeleteReward(DeleteRewardRequest) returns (DeleteRewardReply) {
    option (google.api.http) = {
      delete: "/v1/rewards/{reward_id}"
    };
  }

  // ========== Task API ==========
  // CreateTask 创建任务
  rpc CreateTask(CreateTaskRequest) returns (CreateTaskReply) {
    option (google.api.http) = {
      post: "/v1/tasks"
      body: "*"
    };
  }

  // GetTask 获取任务
  rpc GetTask(GetTaskRequest) returns (GetTaskReply) {
    option (google.api.http) = {
      get: "/v1/tasks/{task_id}"
    };
  }

  // ListTasks 列出任务
  rpc ListTasks(ListTasksRequest) returns (ListTasksReply) {
    option (google.api.http) = {
      get: "/v1/tasks"
    };
  }

  // UpdateTask 更新任务
  rpc UpdateTask(UpdateTaskRequest) returns (UpdateTaskReply) {
    option (google.api.http) = {
      put: "/v1/tasks/{task_id}"
      body: "*"
    };
  }

  // DeleteTask 删除任务
  rpc DeleteTask(DeleteTaskRequest) returns (DeleteTaskReply) {
    option (google.api.http) = {
      delete: "/v1/tasks/{task_id}"
    };
  }

  // ListTasksByCampaign 根据活动列出任务
  rpc ListTasksByCampaign(ListTasksByCampaignRequest) returns (ListTasksByCampaignReply) {
    option (google.api.http) = {
      get: "/v1/campaigns/{campaign_id}/tasks"
    };
  }

  // ========== Audience API ==========
  // CreateAudience 创建受众
  rpc CreateAudience(CreateAudienceRequest) returns (CreateAudienceReply) {
    option (google.api.http) = {
      post: "/v1/audiences"
      body: "*"
    };
  }

  // GetAudience 获取受众
  rpc GetAudience(GetAudienceRequest) returns (GetAudienceReply) {
    option (google.api.http) = {
      get: "/v1/audiences/{audience_id}"
    };
  }

  // ListAudiences 列出受众
  rpc ListAudiences(ListAudiencesRequest) returns (ListAudiencesReply) {
    option (google.api.http) = {
      get: "/v1/audiences"
    };
  }

  // UpdateAudience 更新受众
  rpc UpdateAudience(UpdateAudienceRequest) returns (UpdateAudienceReply) {
    option (google.api.http) = {
      put: "/v1/audiences/{audience_id}"
      body: "*"
    };
  }

  // DeleteAudience 删除受众
  rpc DeleteAudience(DeleteAudienceRequest) returns (DeleteAudienceReply) {
    option (google.api.http) = {
      delete: "/v1/audiences/{audience_id}"
    };
  }

  // ========== RewardGrant API ==========
  // ListRewardGrants 列出奖励发放记录
  rpc ListRewardGrants(ListRewardGrantsRequest) returns (ListRewardGrantsReply) {
    option (google.api.http) = {
      get: "/v1/reward-grants"
    };
  }

  // GetRewardGrant 获取奖励发放记录
  rpc GetRewardGrant(GetRewardGrantRequest) returns (GetRewardGrantReply) {
    option (google.api.http) = {
      get: "/v1/reward-grants/{grant_id}"
    };
  }

  // UpdateRewardGrantStatus 更新发放状态
  rpc UpdateRewardGrantStatus(UpdateRewardGrantStatusRequest) returns (UpdateRewardGrantStatusReply) {
    option (google.api.http) = {
      put: "/v1/reward-grants/{grant_id}/status"
      body: "*"
    };
  }

  // ========== Task Event API ==========
  // TriggerTaskEvent 触发任务事件
  rpc TriggerTaskEvent(TriggerTaskEventRequest) returns (TriggerTaskEventReply) {
    option (google.api.http) = {
      post: "/v1/tasks/trigger"
      body: "*"
    };
  }

  // ========== Inventory Management API ==========
  // ReserveInventory 预占库存
  rpc ReserveInventory(ReserveInventoryRequest) returns (ReserveInventoryReply) {
    option (google.api.http) = {
      post: "/v1/inventory/reserve"
      body: "*"
    };
  }

  // ConfirmInventory 确认库存
  rpc ConfirmInventory(ConfirmInventoryRequest) returns (ConfirmInventoryReply) {
    option (google.api.http) = {
      post: "/v1/inventory/{reservation_id}/confirm"
      body: "*"
    };
  }

  // CancelInventory 取消库存
  rpc CancelInventory(CancelInventoryRequest) returns (CancelInventoryReply) {
    option (google.api.http) = {
      post: "/v1/inventory/{reservation_id}/cancel"
      body: "*"
    };
  }

  // ListInventoryReservations 列出库存预占记录
  rpc ListInventoryReservations(ListInventoryReservationsRequest) returns (ListInventoryReservationsReply) {
    option (google.api.http) = {
      get: "/v1/inventory/reservations"
    };
  }

  // ========== Task Completion Log API ==========
  // ListTaskCompletionLogs 列出任务完成日志
  rpc ListTaskCompletionLogs(ListTaskCompletionLogsRequest) returns (ListTaskCompletionLogsReply) {
    option (google.api.http) = {
      get: "/v1/task-completion-logs"
    };
  }

  // GetTaskCompletionStats 获取任务完成统计
  rpc GetTaskCompletionStats(GetTaskCompletionStatsRequest) returns (GetTaskCompletionStatsReply) {
    option (google.api.http) = {
      get: "/v1/tasks/{task_id}/completion-stats"
    };
  }

  // ========== Campaign Task Management API ==========
  // AddTaskToCampaign 将任务添加到活动
  rpc AddTaskToCampaign(AddTaskToCampaignRequest) returns (AddTaskToCampaignReply) {
    option (google.api.http) = {
      post: "/v1/campaigns/{campaign_id}/tasks"
      body: "*"
    };
  }

  // RemoveTaskFromCampaign 从活动中移除任务
  rpc RemoveTaskFromCampaign(RemoveTaskFromCampaignRequest) returns (RemoveTaskFromCampaignReply) {
    option (google.api.http) = {
      delete: "/v1/campaigns/{campaign_id}/tasks/{task_id}"
    };
  }

  // ListCampaignTasks 列出活动的所有任务
  rpc ListCampaignTasks(ListCampaignTasksRequest) returns (ListCampaignTasksReply) {
    option (google.api.http) = {
      get: "/v1/campaigns/{campaign_id}/tasks"
    };
  }
}

// Campaign 营销活动
message Campaign {
  string campaign_id = 1;        // 活动ID
  string campaign_name = 2;       // 活动名称
  string tenant_id = 3;           // 所属租户
  string product_code = 4;        // 适用产品线
  string campaign_type = 5;       // 活动类型
  string start_time = 6;          // 开始时间
  string end_time = 7;            // 结束时间
  float total_budget = 8;         // 总预算
  map<string, string> rule_config = 9; // 规则配置
  int32 status = 10;              // 状态：0-未开始 1-进行中 2-已结束 3-手动终止
  string created_by = 11;         // 创建人
  string created_at = 12;         // 创建时间
  string updated_at = 13;         // 更新时间
}

// RedeemCode 兑换码
message RedeemCode {
  int64 redeem_code_id = 1;       // 主键ID
  string code = 2;                // 兑换码
  string campaign_id = 3;         // 关联活动ID
  string tenant_id = 4;           // 所属租户
  string product_code = 5;        // 适用产品线
  string code_type = 6;           // 码类型：DISCOUNT-折扣码 COUPON-优惠码 GIFT-礼品码
  int64 user_id = 7;              // 分配用户ID
  int32 status = 8;               // 状态：0-未分配 1-已分配 2-已核销 3-已失效
  float value_amount = 9;         // 面额（金额类）
  float value_percent = 10;       // 折扣比例（百分比类）
  map<string, string> reward_items = 11; // 奖励物品（实物类）
  google.protobuf.Timestamp valid_from = 12;     // 生效时间
  google.protobuf.Timestamp valid_until = 13;    // 过期时间
  google.protobuf.Timestamp redemption_at = 14;  // 核销时间
  string redeem_channel = 15;                    // 核销渠道
  google.protobuf.Timestamp created_at = 16;     // 创建时间
  google.protobuf.Timestamp updated_at = 17;     // 更新时间
}

// CodeBatch 兑换码批次
message CodeBatch {
  string batch_id = 1;            // 批次ID
  string campaign_id = 2;         // 关联活动ID
  string tenant_id = 3;           // 所属租户
  string generate_type = 4;       // 生成方式：MANUAL-手动 AUTO-自动 IMPORT-导入
  int32 total_count = 5;          // 总数量
  int32 used_count = 6;           // 已使用数量
  string operator = 7;            // 操作人
  map<string, string> generate_rule = 8; // 生成规则
  string created_at = 9;          // 创建时间
}

// RedemptionRecord 兑换记录
message RedemptionRecord {
  int64 record_id = 1;            // 记录ID
  int64 redeem_code_id = 2;       // 兑换码ID
  string code = 3;                // 兑换码值
  int64 user_id = 4;              // 用户ID
  string tenant_id = 5;           // 所属租户
  string campaign_id = 6;         // 关联活动ID
  string product_code = 7;        // 产品线
  string redeem_channel = 8;      // 核销渠道
  string redeem_time = 9;         // 核销时间
  string device_info = 10;        // 设备信息
  string ip_address = 11;         // IP地址
  string location = 12;           // 地理位置
  string order_id = 13;           // 关联订单ID
  map<string, string> reward_detail = 14; // 奖励详情
}

// CreateCampaignRequest 创建营销活动请求
message CreateCampaignRequest {
  string campaign_name = 1 [(validate.rules).string = {min_len: 1, max_len: 64}]; // 活动名称
  string tenant_id = 2 [(validate.rules).string.min_len = 1];                      // 所属租户
  string product_code = 3 [(validate.rules).string.min_len = 1];                   // 适用产品线
  string campaign_type = 4 [(validate.rules).string.min_len = 1];                  // 活动类型
  string start_time = 5 [(validate.rules).string.min_len = 1];                     // 开始时间
  string end_time = 6 [(validate.rules).string.min_len = 1];                       // 结束时间
  float total_budget = 7;                                                           // 总预算
  map<string, string> rule_config = 8;                                              // 规则配置
  string created_by = 9;                                                            // 创建人
}

// CreateCampaignReply 创建营销活动响应
message CreateCampaignReply {
  Campaign campaign = 1; // 活动信息
}

// GetCampaignRequest 获取营销活动请求
message GetCampaignRequest {
  string campaign_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }]; // 活动ID
}

// GetCampaignReply 获取营销活动响应
message GetCampaignReply {
  Campaign campaign = 1; // 活动信息
}

// ListCampaignsRequest 列出营销活动请求
message ListCampaignsRequest {
  string tenant_id = 1;     // 所属租户
  string product_code = 2;  // 适用产品线
  string campaign_type = 3; // 活动类型
  int32 status = 4;         // 状态
  int32 page_size = 5;      // 页大小
  int32 page_num = 6;       // 页码
}

// ListCampaignsReply 列出营销活动响应
message ListCampaignsReply {
  repeated Campaign campaigns = 1; // 活动列表
  int32 total = 2;                 // 总数
}

// UpdateCampaignRequest 更新营销活动请求
message UpdateCampaignRequest {
  string campaign_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];                    // 活动ID
  string campaign_name = 2 [(validate.rules).string = {min_len: 1, max_len: 64}];   // 活动名称
  string start_time = 3;                                                             // 开始时间
  string end_time = 4;                                                               // 结束时间
  float total_budget = 5;                                                            // 总预算
  map<string, string> rule_config = 6;                                               // 规则配置
  int32 status = 7;                                                                  // 状态
}

// UpdateCampaignReply 更新营销活动响应
message UpdateCampaignReply {
  Campaign campaign = 1; // 活动信息
}

// DeleteCampaignRequest 删除营销活动请求
message DeleteCampaignRequest {
  string campaign_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }]; // 活动ID
}

// DeleteCampaignReply 删除营销活动响应
message DeleteCampaignReply {
  bool success = 1; // 是否成功
}

// GenerateRedeemCodesRequest 生成兑换码请求
message GenerateRedeemCodesRequest {
  string campaign_id = 1 [(validate.rules).string.min_len = 1];                  // 活动ID
  string code_type = 2 [(validate.rules).string.min_len = 1];                     // 码类型
  int32 count = 3 [(validate.rules).int32.gt = 0];                                // 生成数量
  string generate_type = 4 [(validate.rules).string.min_len = 1];                 // 生成方式
  map<string, string> generate_rule = 5;                                           // 生成规则
  float value_amount = 6;                                                          // 面额
  float value_percent = 7;                                                         // 折扣比例
  map<string, string> reward_items = 8;                                            // 奖励物品
  string expire_time = 9;                                                          // 过期时间
  string operator = 10;                                                            // 操作人
}

// GenerateRedeemCodesReply 生成兑换码响应
message GenerateRedeemCodesReply {
  string batch_id = 1;            // 批次ID
  int32 total_count = 2;          // 总数量
  repeated string sample_codes = 3; // 样例码（最多10个）
}

// RedeemCodeRequest 兑换码核销请求
message RedeemCodeRequest {
  string code = 1 [(validate.rules).string.min_len = 1];        // 兑换码
  int64 user_id = 2 [(validate.rules).int64.gt = 0];            // 用户ID
  string product_code = 3 [(validate.rules).string.min_len = 1]; // 产品线
  string redeem_channel = 4;                                     // 核销渠道
  string device_info = 5;                                        // 设备信息
  string ip_address = 6;                                         // IP地址
  string location = 7;                                           // 地理位置
  string order_id = 8;                                           // 关联订单ID
}

// RedeemCodeReply 兑换码核销响应
message RedeemCodeReply {
  bool success = 1;                             // 是否成功
  string message = 2;                           // 消息
  map<string, string> reward_detail = 3;        // 奖励详情
  RedeemCode code_info = 4;                     // 兑换码信息
}

// AssignRedeemCodeRequest 分配兑换码请求
message AssignRedeemCodeRequest {
  string code = 1 [(validate.rules).string.min_len = 1]; // 兑换码
  int64 user_id = 2 [(validate.rules).int64.gt = 0];     // 用户ID
}

// AssignRedeemCodeReply 分配兑换码响应
message AssignRedeemCodeReply {
  bool success = 1;      // 是否成功
  string message = 2;    // 消息
  RedeemCode code_info = 3; // 兑换码信息
}

// ListRedeemCodesRequest 列出兑换码请求
message ListRedeemCodesRequest {
  string campaign_id = 1;  // 活动ID
  string tenant_id = 2;    // 所属租户
  string product_code = 3; // 适用产品线
  string code_type = 4;    // 码类型
  int32 status = 5;        // 状态
  int64 user_id = 6;       // 用户ID
  int32 page_size = 7;     // 页大小
  int32 page_num = 8;      // 页码
}

// ListRedeemCodesReply 列出兑换码响应
message ListRedeemCodesReply {
  repeated RedeemCode codes = 1; // 兑换码列表
  int32 total = 2;               // 总数
}

// GetRedeemCodeRequest 获取兑换码请求
message GetRedeemCodeRequest {
  string code = 1 [(validate.rules).string.min_len = 1]; // 兑换码
}

// GetRedeemCodeReply 获取兑换码响应
message GetRedeemCodeReply {
  RedeemCode code = 1; // 兑换码信息
}

// ========== Reward Messages ==========
// Reward 奖励
message Reward {
  string reward_id = 1;           // 奖励ID
  string tenant_id = 2;           // 租户ID
  string product_code = 3;         // 产品线
  string reward_type = 4;         // 奖励类型：COUPON/POINTS/REDEEM_CODE/SUBSCRIPTION
  string name = 5;                // 奖励名称
  string content_config = 6;      // 奖励内容配置（JSON）
  string generator_config = 7;    // 生成配置（JSON）
  string distributor_config = 8;  // 发放配置（JSON）
  string validator_config = 9;    // 校验规则配置（JSON）
  int32 version = 10;             // 版本号
  int32 valid_days = 11;          // 有效期（天数）
  string status = 12;             // 状态：ACTIVE/PAUSED/ENDED
  string description = 13;        // 描述
  string created_by = 14;         // 创建人
  google.protobuf.Timestamp created_at = 15; // 创建时间
  google.protobuf.Timestamp updated_at = 16; // 更新时间
}

// CreateRewardRequest 创建奖励请求
message CreateRewardRequest {
  string tenant_id = 1 [(validate.rules).string.min_len = 1];
  string product_code = 2 [(validate.rules).string.min_len = 1];
  string reward_type = 3 [(validate.rules).string.min_len = 1];
  string name = 4 [(validate.rules).string = {min_len: 1, max_len: 128}];
  string content_config = 5 [(validate.rules).string.min_len = 1];
  string generator_config = 6;
  string distributor_config = 7;
  string validator_config = 8;
  int32 valid_days = 9;
  string description = 10;
  string created_by = 11;
}

// CreateRewardReply 创建奖励响应
message CreateRewardReply {
  Reward reward = 1;
}

// GetRewardRequest 获取奖励请求
message GetRewardRequest {
  string reward_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
}

// GetRewardReply 获取奖励响应
message GetRewardReply {
  Reward reward = 1;
}

// ListRewardsRequest 列出奖励请求
message ListRewardsRequest {
  string tenant_id = 1;
  string product_code = 2;
  string reward_type = 3;
  int32 page_size = 4;
  int32 page_num = 5;
}

// ListRewardsReply 列出奖励响应
message ListRewardsReply {
  repeated Reward rewards = 1;
  int32 total = 2;
}

// UpdateRewardRequest 更新奖励请求
message UpdateRewardRequest {
  string reward_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
  string name = 2;
  string content_config = 3;
  string generator_config = 4;
  string distributor_config = 5;
  string validator_config = 6;
  int32 valid_days = 7;
  string status = 8;
  string description = 9;
}

// UpdateRewardReply 更新奖励响应
message UpdateRewardReply {
  Reward reward = 1;
}

// DeleteRewardRequest 删除奖励请求
message DeleteRewardRequest {
  string reward_id = 1 [(validate.rules).string.min_len = 1];
}

// DeleteRewardReply 删除奖励响应
message DeleteRewardReply {
  bool success = 1;
}

// ========== Task Messages ==========
// Task 任务
message Task {
  string task_id = 1;             // 任务ID
  string tenant_id = 2;           // 租户ID
  string product_code = 3;        // 产品线
  string name = 4;                 // 任务名称
  string task_type = 5;           // 任务类型：INVITE/PURCHASE/SHARE/SIGN_IN
  string trigger_config = 6;      // 触发配置（JSON）
  string condition_config = 7;    // 完成条件配置（JSON）
  string reward_id = 8;          // 关联奖励ID
  string status = 9;             // 状态：ACTIVE/PAUSED/ENDED
  string start_time = 10;        // 开始时间
  string end_time = 11;          // 结束时间
  int32 max_count = 12;          // 最大完成次数
  string description = 13;       // 描述
  string created_by = 14;        // 创建人
  google.protobuf.Timestamp created_at = 15; // 创建时间
  google.protobuf.Timestamp updated_at = 16; // 更新时间
}

// CreateTaskRequest 创建任务请求
message CreateTaskRequest {
  string tenant_id = 1 [(validate.rules).string.min_len = 1];
  string product_code = 2 [(validate.rules).string.min_len = 1];
  string name = 3 [(validate.rules).string = {min_len: 1, max_len: 128}];
  string task_type = 4 [(validate.rules).string.min_len = 1];
  string trigger_config = 5;
  string condition_config = 6 [(validate.rules).string.min_len = 1];
  string reward_id = 7;
  string start_time = 8 [(validate.rules).string.min_len = 1];
  string end_time = 9 [(validate.rules).string.min_len = 1];
  int32 max_count = 10;
  string description = 11;
  string created_by = 12;
}

// CreateTaskReply 创建任务响应
message CreateTaskReply {
  Task task = 1;
}

// GetTaskRequest 获取任务请求
message GetTaskRequest {
  string task_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
}

// GetTaskReply 获取任务响应
message GetTaskReply {
  Task task = 1;
}

// ListTasksRequest 列出任务请求
message ListTasksRequest {
  string tenant_id = 1;
  string product_code = 2;
  string task_type = 3;
  int32 page_size = 4;
  int32 page_num = 5;
}

// ListTasksReply 列出任务响应
message ListTasksReply {
  repeated Task tasks = 1;
  int32 total = 2;
}

// UpdateTaskRequest 更新任务请求
message UpdateTaskRequest {
  string task_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
  string name = 2;
  string trigger_config = 3;
  string condition_config = 4;
  string reward_id = 5;
  string start_time = 6;
  string end_time = 7;
  int32 max_count = 8;
  string status = 9;
  string description = 10;
}

// UpdateTaskReply 更新任务响应
message UpdateTaskReply {
  Task task = 1;
}

// DeleteTaskRequest 删除任务请求
message DeleteTaskRequest {
  string task_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
}

// DeleteTaskReply 删除任务响应
message DeleteTaskReply {
  bool success = 1;
}

// ListTasksByCampaignRequest 根据活动列出任务请求
message ListTasksByCampaignRequest {
  string campaign_id = 1 [(validate.rules).string.min_len = 1];
}

// ListTasksByCampaignReply 根据活动列出任务响应
message ListTasksByCampaignReply {
  repeated Task tasks = 1;
}

// ========== Audience Messages ==========
// Audience 受众
message Audience {
  string audience_id = 1;         // 受众ID
  string tenant_id = 2;           // 租户ID
  string product_code = 3;        // 产品线
  string name = 4;                // 受众名称
  string audience_type = 5;       // 受众类型：TAG/SEGMENT/LIST/ALL
  string rule_config = 6;         // 圈选规则配置（JSON）
  string status = 7;              // 状态：ACTIVE/PAUSED/ENDED
  string description = 8;         // 描述
  string created_by = 9;          // 创建人
  google.protobuf.Timestamp created_at = 10; // 创建时间
  google.protobuf.Timestamp updated_at = 11; // 更新时间
}

// CreateAudienceRequest 创建受众请求
message CreateAudienceRequest {
  string tenant_id = 1 [(validate.rules).string.min_len = 1];
  string product_code = 2 [(validate.rules).string.min_len = 1];
  string name = 3 [(validate.rules).string = {min_len: 1, max_len: 128}];
  string audience_type = 4 [(validate.rules).string.min_len = 1];
  string rule_config = 5 [(validate.rules).string.min_len = 1];
  string description = 6;
  string created_by = 7;
}

// CreateAudienceReply 创建受众响应
message CreateAudienceReply {
  Audience audience = 1;
}

// GetAudienceRequest 获取受众请求
message GetAudienceRequest {
  string audience_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
}

// GetAudienceReply 获取受众响应
message GetAudienceReply {
  Audience audience = 1;
}

// ListAudiencesRequest 列出受众请求
message ListAudiencesRequest {
  string tenant_id = 1;
  string product_code = 2;
  string audience_type = 3;
  int32 page_size = 4;
  int32 page_num = 5;
}

// ListAudiencesReply 列出受众响应
message ListAudiencesReply {
  repeated Audience audiences = 1;
  int32 total = 2;
}

// UpdateAudienceRequest 更新受众请求
message UpdateAudienceRequest {
  string audience_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
  string name = 2;
  string rule_config = 3;
  string status = 4;
  string description = 5;
}

// UpdateAudienceReply 更新受众响应
message UpdateAudienceReply {
  Audience audience = 1;
}

// DeleteAudienceRequest 删除受众请求
message DeleteAudienceRequest {
  string audience_id = 1 [(validate.rules).string = {
    min_len: 1,
    max_len: 128,
    pattern: "^[a-zA-Z0-9_-]+$"  // 只允许字母、数字、下划线和连字符，防止 SQL 注入
  }];
}

// DeleteAudienceReply 删除受众响应
message DeleteAudienceReply {
  bool success = 1;
}

// ========== RewardGrant Messages ==========
// RewardGrant 奖励发放记录
message RewardGrant {
  string grant_id = 1;            // 授予ID
  string reward_id = 2;           // 奖励模板ID
  string reward_name = 3;        // 奖励名称
  string reward_type = 4;        // 奖励类型
  int32 reward_version = 5;      // 奖励版本号
  string content_snapshot = 6;   // 奖励内容快照（JSON）
  string campaign_id = 7;        // 活动ID
  string campaign_name = 8;      // 活动名称
  string task_id = 9;            // 任务ID
  string task_name = 10;         // 任务名称
  string tenant_id = 11;         // 租户ID
  string product_code = 12;      // 产品线
  int64 user_id = 13;            // 用户ID
  string status = 14;            // 状态：PENDING/GENERATED/RESERVED/DISTRIBUTED/USED/EXPIRED
  google.protobuf.Timestamp reserved_at = 15;    // 预占时间
  google.protobuf.Timestamp distributed_at = 16; // 发放时间
  google.protobuf.Timestamp used_at = 17;        // 使用时间
  google.protobuf.Timestamp expire_time = 18;     // 过期时间
  string error_message = 19;      // 错误信息
  google.protobuf.Timestamp created_at = 20;      // 创建时间
  google.protobuf.Timestamp updated_at = 21;      // 更新时间
}

// ListRewardGrantsRequest 列出奖励发放记录请求
message ListRewardGrantsRequest {
  string tenant_id = 1;
  string product_code = 2;
  int64 user_id = 3;
  string status = 4;
  string reward_id = 5;
  string campaign_id = 6;
  int32 page_size = 7;
  int32 page_num = 8;
}

// ListRewardGrantsReply 列出奖励发放记录响应
message ListRewardGrantsReply {
  repeated RewardGrant grants = 1;
  int32 total = 2;
}

// GetRewardGrantRequest 获取奖励发放记录请求
message GetRewardGrantRequest {
  string grant_id = 1 [(validate.rules).string.min_len = 1];
}

// GetRewardGrantReply 获取奖励发放记录响应
message GetRewardGrantReply {
  RewardGrant grant = 1;
}

// UpdateRewardGrantStatusRequest 更新发放状态请求
message UpdateRewardGrantStatusRequest {
  string grant_id = 1 [(validate.rules).string.min_len = 1];
  string status = 2 [(validate.rules).string.min_len = 1];
}

// UpdateRewardGrantStatusReply 更新发放状态响应
message UpdateRewardGrantStatusReply {
  bool success = 1;
}

// ========== Task Event Messages ==========
// TriggerTaskEventRequest 触发任务事件请求
message TriggerTaskEventRequest {
  string event_type = 1 [(validate.rules).string.min_len = 1]; // 事件类型：USER_REGISTER, ORDER_PAID
  int64 user_id = 2 [(validate.rules).int64.gt = 0];            // 用户ID
  string tenant_id = 3 [(validate.rules).string.min_len = 1];   // 租户ID
  string product_code = 4 [(validate.rules).string.min_len = 1]; // 产品线
  string campaign_id = 5;                                       // 活动ID（可选）
  string campaign_name = 6;                                     // 活动名称（可选）
  map<string, string> event_data = 7;                          // 事件数据
}

// TriggerTaskEventReply 触发任务事件响应
message TriggerTaskEventReply {
  bool success = 1;
  string message = 2;
  int32 tasks_triggered = 3;    // 触发的任务数量
  int32 rewards_issued = 4;     // 发放的奖励数量
}

// ========== Inventory Management Messages ==========
// InventoryReservation 库存预占记录
message InventoryReservation {
  string reservation_id = 1;     // 预占ID
  string resource_id = 2;        // 资源ID（如奖励ID）
  string campaign_id = 3;        // 活动ID
  int64 user_id = 4;             // 用户ID
  int32 quantity = 5;            // 数量
  string status = 6;             // 状态：PENDING/CONFIRMED/CANCELLED
  google.protobuf.Timestamp expire_at = 7;    // 过期时间
  google.protobuf.Timestamp created_at = 8;   // 创建时间
  google.protobuf.Timestamp updated_at = 9;   // 更新时间
}

// ReserveInventoryRequest 预占库存请求
message ReserveInventoryRequest {
  string resource_id = 1 [(validate.rules).string.min_len = 1];
  string campaign_id = 2;
  int64 user_id = 3 [(validate.rules).int64.gt = 0];
  int32 quantity = 4 [(validate.rules).int32.gt = 0];
  int32 expire_minutes = 5;      // 过期时间（分钟），默认30分钟
}

// ReserveInventoryReply 预占库存响应
message ReserveInventoryReply {
  InventoryReservation reservation = 1;
}

// ConfirmInventoryRequest 确认库存请求
message ConfirmInventoryRequest {
  string reservation_id = 1 [(validate.rules).string.min_len = 1];
}

// ConfirmInventoryReply 确认库存响应
message ConfirmInventoryReply {
  bool success = 1;
}

// CancelInventoryRequest 取消库存请求
message CancelInventoryRequest {
  string reservation_id = 1 [(validate.rules).string.min_len = 1];
}

// CancelInventoryReply 取消库存响应
message CancelInventoryReply {
  bool success = 1;
}

// ListInventoryReservationsRequest 列出库存预占记录请求
message ListInventoryReservationsRequest {
  string resource_id = 1;
  string campaign_id = 2;
  int64 user_id = 3;
  string status = 4;
  int32 page_size = 5;
  int32 page_num = 6;
}

// ListInventoryReservationsReply 列出库存预占记录响应
message ListInventoryReservationsReply {
  repeated InventoryReservation reservations = 1;
  int32 total = 2;
}

// ========== Task Completion Log Messages ==========
// TaskCompletionLog 任务完成日志
message TaskCompletionLog {
  string completion_id = 1;      // 完成记录ID
  string task_id = 2;            // 任务ID
  string task_name = 3;          // 任务名称
  string campaign_id = 4;        // 活动ID
  string campaign_name = 5;      // 活动名称
  int64 user_id = 6;             // 用户ID
  string tenant_id = 7;          // 租户ID
  string product_code = 8;       // 产品线
  string grant_id = 9;          // 奖励发放ID
  string progress_data = 10;     // 进度数据（JSON）
  string trigger_event = 11;     // 触发事件
  google.protobuf.Timestamp completed_at = 12;  // 完成时间
  google.protobuf.Timestamp created_at = 13;   // 创建时间
  google.protobuf.Timestamp updated_at = 14;    // 更新时间
}

// ListTaskCompletionLogsRequest 列出任务完成日志请求
message ListTaskCompletionLogsRequest {
  string tenant_id = 1;
  string product_code = 2;
  string task_id = 3;
  string campaign_id = 4;
  int64 user_id = 5;
  int32 page_size = 6;
  int32 page_num = 7;
}

// ListTaskCompletionLogsReply 列出任务完成日志响应
message ListTaskCompletionLogsReply {
  repeated TaskCompletionLog logs = 1;
  int32 total = 2;
}

// GetTaskCompletionStatsRequest 获取任务完成统计请求
message GetTaskCompletionStatsRequest {
  string task_id = 1 [(validate.rules).string.min_len = 1];
  string campaign_id = 2;
  int64 user_id = 3;
}

// GetTaskCompletionStatsReply 获取任务完成统计响应
message GetTaskCompletionStatsReply {
  string task_id = 1;
  int32 total_completions = 2;   // 总完成次数
  int32 unique_users = 3;         // 唯一用户数
  int64 user_completions = 4;     // 指定用户的完成次数（如果提供了 user_id）
}

// ========== Campaign Task Management Messages ==========
// CampaignTask 活动-任务关联
message CampaignTask {
  int64 campaign_task_id = 1;    // 关联ID
  string campaign_id = 2;        // 活动ID
  string task_id = 3;            // 任务ID
  string config = 4;             // 组合配置（JSON）
  int32 sort_order = 5;          // 排序顺序
  google.protobuf.Timestamp created_at = 6;  // 创建时间
  google.protobuf.Timestamp updated_at = 7;  // 更新时间
}

// AddTaskToCampaignRequest 将任务添加到活动请求
message AddTaskToCampaignRequest {
  string campaign_id = 1 [(validate.rules).string.min_len = 1];
  string task_id = 2 [(validate.rules).string.min_len = 1];
  int32 sort_order = 3;          // 排序顺序
  string config = 4;             // 组合配置（JSON）
}

// AddTaskToCampaignReply 将任务添加到活动响应
message AddTaskToCampaignReply {
  CampaignTask campaign_task = 1;
}

// RemoveTaskFromCampaignRequest 从活动中移除任务请求
message RemoveTaskFromCampaignRequest {
  string campaign_id = 1 [(validate.rules).string.min_len = 1];
  string task_id = 2 [(validate.rules).string.min_len = 1];
}

// RemoveTaskFromCampaignReply 从活动中移除任务响应
message RemoveTaskFromCampaignReply {
  bool success = 1;
}

// ListCampaignTasksRequest 列出活动的所有任务请求
message ListCampaignTasksRequest {
  string campaign_id = 1 [(validate.rules).string.min_len = 1];
}

// ListCampaignTasksReply 列出活动的所有任务响应
message ListCampaignTasksReply {
  repeated CampaignTask campaign_tasks = 1;
}
